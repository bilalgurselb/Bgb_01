@model IEnumerable<SiparisApi.Models.OrderListVm>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    var userAgent = Context.Request.Headers["User-Agent"].ToString();
    var isMobile = userAgent.Contains("Mobi")
                || userAgent.Contains("Android")
                || userAgent.Contains("iPhone");
}
@functions {
    public static string GetCurrencyIcon(string currency)
    {
        return currency?.ToUpperInvariant() switch
        {
            "EUR" => "<i class='fas fa-euro-sign'></i>",
            "USD" => "<i class='fas fa-dollar-sign'></i>",
            "RUB" => "<i class='fas fa-ruble-sign'></i>",
            "TRY" => "<i class='fas fa-lira-sign'></i>",
            _ => $"<span>{currency}</span>"
        };
    }
}
@functions {
    public static string ShortenProduct(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return name;

        int index = name.IndexOf("(");
        if (index > 0)
            return name.Substring(0, index).Trim();

        return name.Trim();
    }
}

@if (Model == null || !Model.Any(o => o.Items.Any()))
{
    <div class="d-flex justify-content-center align-items-center text-center" style="height:60vh;">
        <div>
            <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
            <h5 class="text-secondary">Kayıtlı sipariş bulunmamaktadır.</h5>

            <a href="@Url.Action("Create", "OrdersUIList")"
               class="btn btn-primary mt-3">
                <i class="fas fa-plus"></i> Yeni Sipariş
            </a>
        </div>
    </div>
}
else
{
  
    var totalOrders = Model.Count();
    var totalKg = Model.Sum(o => o.Items.Sum(i => i.NetWeight));

    var currencyTotals = Model
        .GroupBy(o => o.Currency)
        .Select(g => new { Currency = g.Key, Amount = g.Sum(o => o.Items.Sum(x => x.Total)) })
        .ToList();

    var productTotals = Model
        .SelectMany(o => o.Items)
        .GroupBy(i => i.ProductName)
        .Select(g => new { Product = g.Key, Kg = g.Sum(x => x.NetWeight) })
        .ToList();

    var repTotals = Model
        .GroupBy(o => o.SalesRepName)
        .Select(g => new {
            Rep = g.Key,
            Kg = g.Sum(x => x.Items.Sum(i => i.NetWeight)),
            Count = g.Sum(x => x.Items.Count)
        }).ToList();

    var countryTotals = Model
        .GroupBy(o => o.Country)
        .Select(g => new {
            Country = g.Key,
            Kg = g.Sum(x => x.Items.Sum(i => i.NetWeight))
        }).ToList();

    <!-- =======================
         ÖZET PANELİ
    ==========================-->
    <div class="summary-header">    
        <div class="summary-title-row">
            <div class="summary-title-left">
                <i class="fas fa-receipt"></i>
                <span>Sipariş Özeti</span>
             </div>
            <button id="summaryToggleBtn" class="summary-toggle-btn">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
            <div class="summary-tabs">
                <span class="summary-tab active" data-tab="genel">Genel</span>
                <span class="summary-tab" data-tab="urun">Ürün</span>
                <span class="summary-tab" data-tab="temsilci">Temsilci</span>
                <span class="summary-tab country-tab" data-tab="ulke">Ülke/Şehir</span>
            </div>     
    </div>        
   

        <!-- BODY -->
        <div class="summary-body" id="summaryBody">
            <!-- ===== GENEL (KAPALI HAL) ===== -->
            <div id="genel-compact" class="summary-section">
                <div class="summary-row">
                    <span>Toplam Sipariş:</span>
                    <strong>@Model.Count() adet</strong>
                </div>
                <div class="summary-row">
                    <span>Toplam Net KG:</span>
                    <strong>@Model.Sum(o => o.Items.Sum(i => i.NetWeight)).ToString("N2")</strong>
                </div>
            </div>

            <!-- ===== GENEL (AÇIK HAL / SEKMENİN KENDİSİ) ===== -->
            <div class="summary-section d-none" id="tab-genel">

                <div class="summary-row">
                    <span>Toplam Sipariş:</span>
                    <strong>@Model.Count() adet</strong>
                </div>

                <div class="summary-row">
                    <span>Toplam Net KG:</span>
                    <strong>@Model.Sum(o => o.Items.Sum(i => i.NetWeight)).ToString("N2")</strong>
                </div>

                <hr />

                @foreach (var grp in Model
                            .GroupBy(o => o.Currency ?? "EUR")
                            .Select(g => new { c = g.Key, t = g.Sum(o => o.Items.Sum(i => i.Total)) }))
                {
                    <div class="summary-row">
                        <span>@grp.c:</span>
                        <strong>@grp.t.ToString("N2")</strong>
                    </div>
                }
            </div>
            <style>
                #genel-compact {
                    display: block;
                }

                .expanded #genel-compact {
                    display: none;
                }
            </style>
            <!-- ================= ÜRÜN ================= -->
            <div class="summary-section d-none" id="tab-urun">
                @foreach (var p in Model
                            .SelectMany(o => o.Items)
                            .GroupBy(i => i.ProductName)
                            .Select(g => new
                            {
                                Name = g.Key,
                                Kg = g.Sum(x => x.NetWeight)
                            })
                .OrderByDescending(x => x.Kg))
                {
                    <div class="summary-row">
                        <span>@p.Name:</span>
                        <strong>@p.Kg.ToString("N2") KG</strong>
                    </div>
                }
            </div>

            <!-- ================= TEMSİLCİ ================= -->
            <div class="summary-section d-none" id="tab-temsilci">
                @foreach (var rep in Model
                            .GroupBy(o => o.SalesRepName)
                            .Select(g => new
                            {
                                Rep = g.Key,
                                Kg = g.Sum(o => o.Items.Sum(i => i.NetWeight)),
                                Count = g.Sum(o => o.Items.Count),

                                Products = g.SelectMany(o => o.Items)
                            .GroupBy(i => ShortenProduct(i.ProductName))
                            .Select(p => $"{p.Key} ({p.Sum(x => x.NetWeight):N2} KG)")
                            .OrderByDescending(x => x)
                            .ToList()
                            })
                            .OrderByDescending(p => p.Kg)
                            .ToList())
                {
                    <div class="summary-row rep-block">
                        <div class="rep-left">
                            <span class="rep-name">@rep.Rep</span>

                            <div class="rep-products">
                                @foreach (var pr in rep.Products)
                                {
                                    <div>@pr</div>
                                }
                            </div>
                        </div>

                        <div class="rep-right">
                            <strong>@rep.Kg.ToString("N2") KG</strong><br />
                            <span class="summary-info">(@rep.Count ürün)</span>
                        </div>
                    </div>
                }
            </div>

            <!-- ================= ÜLKE ================= -->
            <div class="summary-section d-none" id="tab-ulke">
                @foreach (var c in Model
                            .GroupBy(o => o.Country)
                            .Select(g => new
                            {
                                Country = g.Key,
                                Kg = g.Sum(o => o.Items.Sum(i => i.NetWeight))
                            })
                .OrderByDescending(x => x.Kg))
                {
                    <div class="summary-row">
                        <span>@c.Country:</span>
                        <strong>@c.Kg.ToString("N2") KG</strong>
                    </div>
                }
            </div>

        </div>
       



    if (isMobile)
    {
        @Html.Partial("_OrderCardsMobile", Model)
    }
    else
    {
        @Html.Partial("_OrderTableDesktop", Model)
    }
}
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const sections = {
                genel: document.getElementById("tab-genel"),
                urun: document.getElementById("tab-urun"),
                temsilci: document.getElementById("tab-temsilci"),
                ulke: document.getElementById("tab-ulke")
            };

            const tabs = document.querySelectorAll(".summary-tab");
            const toggleBtn = document.getElementById("summaryToggleBtn");
            let toggleIcon = null;
            if(toggleBtn){
                  toggleIcon = toggleBtn.querySelector("i");
            }
          

            const compactGenel = document.getElementById("genel-compact");

            let isExpanded = false;
            let activeTab = "genel";

            // --- TÜM DETAYLARI KAPAT ---
            function collapseAll() {
                Object.values(sections).forEach(sec => sec.classList.add("d-none"));
                compactGenel.style.display = "block";          // Genel compact görünür
                toggleBtn.classList.remove("rotated");
            }

            // --- TAB GÖSTER ---
            function showTab(tabName) {
                activeTab = tabName;
                collapseAll();
                sections[tabName].classList.remove("d-none");
                compactGenel.style.display = "none";           // Detay açıldı → compact kapanır
                isExpanded = true;
                toggleBtn.classList.add("rotated");

                tabs.forEach(t => t.classList.remove("active"));
                document.querySelector(`[data-tab='${tabName}']`).classList.add("active");
            }

            // --- TAB TIKLAMA ---
            tabs.forEach(tab => {
                tab.addEventListener("click", function () {
                    const selected = this.dataset.tab;
                    showTab(selected);
                });
            });

            // --- OK TIKLAMA ---
            toggleBtn.addEventListener("click", function () {
                if (isExpanded) {
                    // KAPAT
                    collapseAll();
                    isExpanded = false;

                    activeTab = "genel"; // ❗ Reset zorunlu
                    tabs.forEach(t => t.classList.remove("active"));
                    document.querySelector(`[data-tab='genel']`).classList.add("active");
                } else {
                    // AÇ → aktif olan tabı aç
                    showTab(activeTab);
                }
            });

            // --- İlk yükleme: kapalı + genel aktif ---
            collapseAll();
            document.querySelector("[data-tab='genel']").classList.add("active");
        });
    </script>
}


