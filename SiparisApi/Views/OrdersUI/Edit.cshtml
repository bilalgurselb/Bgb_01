@model SiparisApi.Models.OrderHeader

@{
    ViewData["Title"] = "Sipariş Düzenle";
    Layout = "_Layout";
    var items = Model.Items?.ToList() ?? new List<SiparisApi.Models.OrderItem>();
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="page-header d-flex justify-content-between align-items-center mb-3">
    <h3 class="page-title"><i class="fas fa-edit text-primary"></i> Sipariş Düzenle</h3>
    <a asp-action="Index" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Listeye Dön</a>
</div>

<div class="form-card">
    <form id="editOrderForm">
        <input type="hidden" id="orderId" value="@Model.Id" />

        <div class="form-group mb-3">
            <label>Müşteri</label>
            <input type="text" class="form-control" value="@Model.CustomerId?" readonly />
        </div>

        <div class="form-group mb-3">
            <label>Durum</label>
            <select id="status" class="form-select">
                <option value="Onay Bekleniyor" selected="@((Model.Status ?? "") == "Onay Bekleniyor")">🟡 Onay Bekleniyor</option>
                <option value="Onaylandı / Üretimde" selected="@((Model.Status ?? "") == "Onaylandı / Üretimde")">🟢 Onaylandı / Üretimde</option>
                <option value="Üretildi" selected="@((Model.Status ?? "") == "Üretildi")">🔵 Üretildi</option>
                <option value="Tamamlandı / Teslim Edildi" selected="@((Model.Status ?? "") == "Tamamlandı / Teslim Edildi")">🟣 Teslim Edildi</option>
                <option value="İptal" selected="@((Model.Status ?? "") == "İptal")">🔴 İptal</option>
            </select>
        </div>

        <h5 class="mt-4 mb-2">🧾 Ürün Detayları</h5>

        <table class="table table-bordered align-middle">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Ürün</th>
                    <th>Miktar</th>
                    <th>Fiyat</th>
                    <th>Not</th>
                </tr>
            </thead>
            <tbody>
                @if (items.Count > 0)
                {
                    for (int i = 0; i < items.Count; i++)
                    {
                        <tr>
                            <td>@(i + 1)</td>

                            <td>
                                <!-- Ürün adı alanın yoksa şimdilik ProductId gösteriyoruz -->
                                <!-- Daha sonra SintanStok'tan ad çekmek için burayı güncelleriz -->
                                <span class="text-muted">ProductId:</span> @items[i].ProductId
                                <input type="hidden" name="Items[@i].Id" value="@items[i].Id" />
                                <input type="hidden" name="Items[@i].ProductId" value="@items[i].ProductId" />
                            </td>

                            <td>
                                <input type="number"
                                       name="Items[@i].Quantity"
                                       step="0.01"
                                       value="@items[i].Quantity"
                                       class="form-control" />
                            </td>

                            <td>
                                <input type="number"
                                       name="Items[@i].Price"
                                       step="0.01"
                                       value="@items[i].Price"
                                       class="form-control" />
                            </td>

                            <td>
                                <input type="text"
                                       name="Items[@i].Description"
                                       value="@items[i].Description"
                                       class="form-control" />
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Bu siparişe ait ürün detayı bulunamadı.
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="form-group mb-3">
            <label>Teslim Yeri</label>
            <input type="text" id="placeOfDelivery" class="form-control" value="@Model.PlaceOfDelivery" />
        </div>

        <button type="submit" class="btn btn-success w-100">
            <i class="fas fa-save"></i> Güncelle
        </button>
    </form>
</div>

@section Scripts {
    <script>
        document.getElementById("editOrderForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const token = sessionStorage.getItem("AccessToken");
            if (!token) {
                alert("Oturum bulunamadı. Lütfen yeniden giriş yapın.");
                return;
            }

            const orderId = parseInt(document.getElementById("orderId").value);
            const status = document.getElementById("status").value;
            const placeOfDelivery = document.getElementById("placeOfDelivery").value;

            // Ürün satırlarını oku (Id ve ProductId dahil!)
            const rows = Array.from(document.querySelectorAll("tbody tr"));
            const items = rows.map((row, idx) => {
                const q = row.querySelector(`input[name="Items[${idx}].Quantity"]`);
                const p = row.querySelector(`input[name="Items[${idx}].Price"]`);
                const d = row.querySelector(`input[name="Items[${idx}].Description"]`);
                const id = row.querySelector(`input[name="Items[${idx}].Id"]`);
                const pid = row.querySelector(`input[name="Items[${idx}].ProductId"]`);

                return {
                    id: id ? parseInt(id.value) : 0,
                    productId: pid ? parseInt(pid.value) : 0,
                    quantity: q ? parseFloat(q.value) : 0,
                    price: p ? parseFloat(p.value) : 0,
                    description: d ? d.value : ""
                };
            });

            const order = {
                id: orderId,
                status: status,
                placeOfDelivery: placeOfDelivery,
                items: items
            };

            const response = await fetch(`/OrdersUIList/Edit/${orderId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(order)
            });

            if (response.ok) {
                alert("Sipariş başarıyla güncellendi!");
                window.location.href = "/OrdersUIList/Index";
            } else {
                alert("Bir hata oluştu. Lütfen tekrar deneyin.");
            }
        });
    </script>
}
