@{
    ViewData["Title"] = "Yeni Sipariş Oluştur";
    Layout = "_Layout";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@{
    var accessToken = Context.Session.GetString("AccessToken");
}
<div class="form-card bg-white shadow-sm p-3 rounded">
    <form id="createOrderForm">

        <!-- 🔹 MÜŞTERİ SEÇİMİ -->
        <div class="form-group mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <label class="mb-1">Customer</label>
                 <a href="#" id="btnAddCustomer" class="text-primary small">+ Add New Customer</a> 
            </div>
            <select id="customerSelect" class="form-control" required></select>
            <div id="customerInfo" class="text-muted small mt-1"></div>
        </div>

        <!-- 🔹 SATIŞ TEMSİLCİSİ -->
        <div class="form-group mb-3">
            <label>Representative</label>
            <select id="salesRepSelect" class="form-control" required></select>
        </div>

        <!-- 🔹 TARİHLER -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Order Date</label>
                <input type="date" id="orderDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
            </div>
            <div class="col-md-6 mb-3">
                <label>Delivery Date</label>
                <input type="date" id="deliveryDate" class="form-control" />
            </div>
        </div>

        <!-- 🔹 ÖDEME & TAŞIMA ŞARTLARI -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Payment Term</label>
                <select id="paymentTerm" class="form-control" required></select>
            </div>
            <div class="col-md-6 mb-3">
                <label>Transport Type</label>
                <select id="transport" class="form-control" required></select>
            </div>
        </div>

        <!-- 🔹 TESLİMAT BİLGİLERİ -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Port of Delivery</label>
                <select id="portOfDelivery" class="form-control" ></select>
            </div>
            <div class="col-md-6 mb-3">
                <label>Place of Delivery</label>
                <select id="placeOfDelivery" class="form-control" ></select>
            </div>
            <div class="form-group mb-3">
                <label>Delivery Term</label>
                <select id="deliveryTerm" class="form-select" >
                    <option value="">Choose...</option>
                    <option value="CFR">CFR (Cost and Freight)</option>
                    <option value="CIF">CIF (Cost, Insurance and Freight)</option>
                    <option value="FOB">FOB (Free on Board)</option>
                    <option value="DAP">DAP (Delivered At Place)</option>
                </select>
            </div>
            <div class="form-group mb-3">
                <label for="dueDays">Due Date (Days)</label>
                <input type="number" id="dueDays" class="form-control" inputmode="numeric" min="0" step="1" placeholder="örnek: 30" />
            </div>
        </div>

        <!-- 🔹 PARA BİRİMİ -->
        <div class="form-group mb-3">
            <label>Currency</label>
            <select id="currency" class="form-control" required></select>
        </div>

        <!-- 🔹 ÜRÜN SATIRLARI -->
        <div class="mt-4">
            <h5><i class="fas fa-box text-success"></i>Products</h5>
            <div id="itemsContainer"></div>
            <button type="button" id="addItem" class="btn btn-sm btn-success mt-2">
                <i class="fas fa-plus"></i> Add Product
            </button>
        </div>

        <!-- 🔹 KAYDET -->
        <button type="submit" class="btn btn-primary w-100 mt-4">
            <i class="fas fa-save"></i> Kaydet
        </button>
    </form>
</div>
<div id="smartProductDropdown" class="smart-dropdown hidden">
    <div class="smart-dropdown-header">
        <input type="text" id="smartProductSearch" placeholder="Ürün ara..." />
        <button id="smartProductClose" type="button">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div id="smartProductList" class="smart-dropdown-list">
        <!-- JS otomatik dolduracak -->
    </div>
</div>
<!-- 🔹 TOAST & MODAL -->
<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1080">
    <div id="toastWarning" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">⚠️ Eksik veya hatalı bilgi var. Lütfen kontrol edin.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>
<!-- 🔹 Sipariş Özeti Modal -->
<!-- 🔹 Sipariş Özeti Modal (YENİ TASARIM) -->
<div class="modal fade" id="orderSummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content shadow">

            <!-- HEADER -->
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-receipt me-2"></i> Sipariş Özeti
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- BODY -->
            <div class="modal-body" id="orderSummaryBody">
                <!-- JS özet kartlarını buraya basar -->
            </div>

            <!-- FOOTER -->
            <div class="modal-footer d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> İptal
                </button>
                <button type="button" class="btn btn-success px-4" id="confirmSaveBtn">
                    <i class="fas fa-check"></i> Onayla ve Kaydet
                </button>
            </div>

        </div>
    </div>
</div>

 <!-- Yeni Müşteri Modal -->
<!-- 🔹 Yeni Müşteri Ekle Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addCustomerForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="newCustomerName" required>
                    </div>
                  <!-- <div class="mb-3">
                        <label class="form-label">City</label>
                        <input type="text" class="form-control" id="newCustomerCity" required>
                    </div> -->
                    <div class="mb-3">
                        <label class="form-label">Country/City</label>
                        <input type="text" class="form-control" id="newCustomerCountry" required>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>




@section Scripts {
    <script src="/js/lookups.js"></script>
    <script>
                 /*        setTimeout(() => {
            console.log("🔎 TEST: Rep Select Value:", document.getElementById("salesRepSelect")?.value);
            console.log("🔎 TEST: Rep Select Options:", document.getElementById("salesRepSelect")?.options.length);
            console.log("🔎 TEST: Token:", sessionStorage.getItem("AccessToken"));
        }, 1500);
        */
                   const accessToken = '@accessToken';
        if (accessToken) {
            sessionStorage.setItem("AccessToken", accessToken);
        }

        /* === 🧩 SİNTAN: Sayfa Yenilemeyi Engelleme + Güvenli Lookup Yükleme === */
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // 🔹 Masaüstü için klasik yenilemeyi engelle
                window.addEventListener("beforeunload", e => {
                    const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
                    if (!isMobile) {
                        e.preventDefault();
                        e.returnValue = ""; // Chrome, Edge, Firefox için
                    }
                });

                // 🔹 Lookup verilerini tam yükle, sonra satır ekle
                await loadLookups();
                addOrderItemRow();

                // 🔹 Mobilde "çek-bırak yenileme"yi engelle (Android & iOS)
                let touchStartY = 0;
                document.addEventListener("touchstart", e => {
                    touchStartY = e.touches[0].clientY;
                });

                document.addEventListener("touchmove", e => {
                    const touchCurrentY = e.touches[0].clientY;
                    const scrollTop = document.scrollingElement.scrollTop;
                    // Sayfanın en üstünde aşağı çekiliyorsa: (pull-to-refresh)
                    if (scrollTop === 0 && touchCurrentY > touchStartY) {
                        e.preventDefault();
                    }
                }, { passive: false });

                // 🔹 Formdaki değişiklikleri algıla (ekstra güvenlik)
                let formChanged = false;
                document.querySelectorAll("#createOrderForm input, #createOrderForm select")
                    .forEach(el => el.addEventListener("input", () => formChanged = true));

                // 🔹 Geri tuşu veya yönlendirme engellemesi (SPA senaryosu)
                window.addEventListener("popstate", e => {
                    if (formChanged && !confirm("Kaydedilmemiş veriler var. Devam etmek istiyor musunuz?")) {
                        history.pushState(null, null, location.href);
                        e.preventDefault();
                    }
                });

            } catch (err) {
                console.error("❌ Sayfa yüklenirken hata:", err);
            }
        });

    
               // 🔹 ÜRÜN SATIRI EKLE
        function addOrderItemRow() {
            const container = document.getElementById("itemsContainer");
            if (!container) return;

            const rowIndex = container.children.length + 1;

            const row = document.createElement("div");
            row.className = "item-row border p-2 rounded mb-2 bg-white shadow-sm";

            row.innerHTML = `
                <div class="item-row-header d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-primary">#${rowIndex}</span>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-item" aria-label="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="col-12 mb-2">
                    <label>Product</label>
                    <select class="product-select form-control" required></select>
                </div>

                <div class="row">
                    <div class="col-6 mb-2">
                        <label>Quantity</label>
                        <input type="number"
                               class="form-control quantity"
                               inputmode="decimal"
                               step="0.01"
                               placeholder="Enter quantity"
                               required />
                    </div>

                    <div class="col-6 mb-2">
                        <label>Unit</label>
                        <select class="form-control unit-select" required></select>
                    </div>

                    <div class="col-6 mb-2">
                        <label>Price</label>
                        <input type="number"
                               class="form-control price"
                               inputmode="decimal"
                               step="0.0001"
                               required
                               placeholder="Enter price" />
                    </div>

                    <div class="col-6 mb-2">
                        <label>Total</label>
                        <div class="input-group">
                            <input type="text"
                                   class="form-control total-amount"
                                   value="0.00"
                                   readonly />
                            <span class="input-group-text currency-label"
                                  style="min-width: 2.5rem; font-size: 1.2rem; justify-content: center;">€</span>
                        </div>
                    </div>

                    <div class="col-12 mb-2">
                        <label>Description</label>
                        <textarea class="form-control description"
                                  rows="2"
                                  placeholder="Açıklama girin..."></textarea>
                    </div>
                </div>

                <small class="text-muted net-weight-info d-block ms-1 mt-1">
                    Net Weight: -
                </small>
            `;

            container.appendChild(row);

            // Ürün select'i doldur
            const productSelect = row.querySelector(".product-select");
            if (productSelect) {
                productSelect.id = `productselect_${Date.now()}_${rowIndex}`;
                fillProductSelect(productSelect);
            }

            // Unit select
            const unitSelect = row.querySelector(".unit-select");
            if (unitSelect) {
                loadUnits(unitSelect);
            }

            updateRowNumbers();

            // Para birimi seçiliyse toplam hesaplarını tazele
            document.getElementById("currency")?.dispatchEvent(new Event("change"));
        }         

        // 🔹 Satır numaralarını yeniden sırala
        function updateRowNumbers() {
            document.querySelectorAll("#itemsContainer .item-row").forEach((row, index) => {
                const badge = row.querySelector(".badge");
                if (badge) badge.textContent = `#${index + 1}`;
            });
        }
        // 🔹 Ürün Satırı Silme (Delegated Listener)
        document.addEventListener("click", function (e) {
            const btn = e.target.closest(".remove-item");
            if (!btn) return;

            const row = btn.closest(".item-row");
            if (row) {
                row.remove();
                updateRowNumbers();
            }
        });

   

        // 🔹 TOAST
        function showToast(msg) {
            const toastEl = document.getElementById("toastWarning");
            toastEl.querySelector(".toast-body").innerText = msg;
            new bootstrap.Toast(toastEl).show();
        }

        document.getElementById("createOrderForm").addEventListener("submit", function (e) {
            e.preventDefault(); // Formun klasik gönderimini iptal eder
        });


        /*---HESAPLAMA-------*/addOrderItemRow
                /* === 🔹 HESAP MODÜLÜ (Bankacılık Tipi Para Hesabı) === */


        /* --- 🔹 Ondalık normalizasyonu --- */
        function normalizeFloat(v) {
            if (typeof v === "string") v = v.replace(",", ".").trim();
            return parseFloat(v) || 0;
        }

        /* --- 🔹 Banker’s rounding (Round half even) --- */
        function roundBankers(value, decimals = 2) {
            const factor = Math.pow(10, decimals);
            const n = value * factor;
            const f = Math.floor(n);
            const diff = n - f;

            if (diff > 0.5) return (f + 1) / factor;
            if (diff < 0.5) return f / factor;
            // Tam ortadaysa çift sayıya yuvarla
            return (f % 2 === 0 ? f : f + 1) / factor;
        }

        /* --- 🔹 Bankacılık tipi çarpım --- */
        function preciseMoneyMultiply(price, qty) {
            const p = Math.round(normalizeFloat(price) * 10000); // 4 ondalık precision
            const q = Math.round(normalizeFloat(qty) * 10000);
            const result = (p * q) / 100000000; // 8 ondalık
            return roundBankers(result, 2);
        }



        function recalcRowTotal(row) {
               console.log("🧮 recalcRowTotal çalıştı", row);
            if (!row) return;
               console.log("🧮 recalcRowTotal çalıştı", row);
            const qtyEl   = row.querySelector(".quantity");
            const priceEl = row.querySelector(".price");
            const totalEl = row.querySelector(".total-amount");
            const unitEl  = row.querySelector(".unit-select");
            const curEl   = row.querySelector(".currency-label");
            const lblInfo = row.querySelector(".net-weight-info");

            const cur = document.getElementById("currency")?.value || "EURO";
            const symbols = { USD: "$", EURO: "€", TL: "₺", RUBLE: "₽" };
            const sym = symbols[cur] || "";

            const qty = parseFloat(qtyEl.value) || 0;
            const price = parseFloat(priceEl.value) || 0;
            const unit = unitEl?.value || "";
              console.log(row.dataset)

        const packWeight = normalizeFloat(row.dataset.packWeight);
        const palletNet  = normalizeFloat(row.dataset.palletNet);

        let netKg = 0;

             if (!unit) {
            if (lblInfo) lblInfo.textContent = `Net Weight: ${row.dataset.netKg || '-'}`;
            if (totalEl) totalEl.value = "0.00";
            return;
        }

        switch (unit) {
            case "Pallets":
                netKg = qty * palletNet;
                break;
            case "Pieces":
            case "IBC":
                netKg = qty * packWeight;
                break;
        }
           if (lblInfo) {
          lblInfo.textContent = `Net Weight: ${netKg.toFixed(2)} KG`;
          row.dataset.netKg = netKg.toFixed(2);
           }
           

            const total = preciseMoneyMultiply(price, netKg);

            if (totalEl) totalEl.value = total.toFixed(2);
            if (curEl) curEl.textContent = sym;



            if (lblInfo)
                lblInfo.textContent = netKg > 0 ? `Net Weight: ${netKg.toFixed(2)} kg` : "Net Weight: -";

            row.style.borderLeft = total > 0 ? "4px solid #47AAC6" : "4px solid transparent";
        }
           /* --- 🔹 Toplamlar (Alt Toplam, KDV, Genel Toplam) --- */
          function calculateOrderTotals() {
              let subtotal = 0;
              document.querySelectorAll('.total-amount').forEach(el => {
                  subtotal += normalizeFloat(el.value);
              });

           /*   const vatRate = 0.18;
              const vat = roundBankers(subtotal * vatRate, 2);
              const grandTotal = roundBankers(subtotal + vat, 2);

              document.getElementById('subtotalDisplay')?.textContent = subtotal.toFixed(2);
              document.getElementById('vatDisplay')?.textContent = vat.toFixed(2);
              document.getElementById('grandTotalDisplay')?.textContent = grandTotal.toFixed(2);*/
          }            
        
                /* --- 🔹 Tetikleyiciler (Event Binding) --- */

        // Miktar, fiyat veya birim değişince
        document.addEventListener('change', e => {
            if (e.target.matches('.quantity, .price, .unit-select')) {
                const row = e.target.closest('.item-row');
                if (row) {
                    recalcRowTotal(row);
                    calculateOrderTotals();
                }
            }
        });

        // Para birimi değişince
        document.getElementById('currency')?.addEventListener('change', () => {
            document.querySelectorAll('.item-row').forEach(row => recalcRowTotal(row));
            calculateOrderTotals();
        });

        // === Currency seçilince Price yanına sembol yaz ===
      (function attachCurrencySymbolBinding(){
            const cur = document.getElementById("currency");
            if (!cur) return;
            const symbols = { USD: "$", EURO: "€", TL: "₺", RUBLE: "₽" };

            function refreshSymbols(){
                const symbol = symbols[cur.value] || "";
                  document.querySelectorAll(".price-symbol").forEach(el => el.textContent = symbol);
             document.querySelectorAll(".currency-label").forEach(el => el.textContent = symbol);
              }
            cur.addEventListener("change", refreshSymbols);
            setTimeout(refreshSymbols, 0);
        })();

        // 🔹 KAYDET
      
            const form = document.getElementById("createOrderForm");
        const orderDateRaw = document.getElementById("orderDate").value;
        const deliveryDateRaw = document.getElementById("deliveryDate").value;
        const orderDate = orderDateRaw ? new Date(orderDateRaw).toISOString() : null;
        const deliveryDate = deliveryDateRaw ? new Date(deliveryDateRaw).toISOString() : null;
        const uid =Date.now() + "-" + Math.random().toString(36).substring(2, 8);
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const invalidRows = [];
                const order = {
                    Uid: uid,
                    CustomerId: document.getElementById("customerSelect").value,
                    SalesRepId: parseInt(document.getElementById("salesRepSelect").value),
                    OrderDate: orderDate,
                    DeliveryDate: deliveryDate,
               //     OrderDate: document.getElementById("orderDate").value,
               //     DeliveryDate: document.getElementById("deliveryDate").value,
                    PaymentTerm: document.getElementById("paymentTerm").value,
                    Transport: document.getElementById("transport").value || null,
                    DueDays: parseInt(document.getElementById("dueDays").value) || 0,
                    Currency: document.getElementById("currency").value,
                    PortOfDelivery: document.getElementById("portOfDelivery").value,
                    PlaceOfDelivery: document.getElementById("placeOfDelivery").value,
                   // CreatedById: 1, // Gerekirse auth'dan alınır
                    Items: []
                };
                    
                // 🔒 Zorunlu alanlar (başlık)
                if (!order.CustomerId || !order.SalesRepId || !order.OrderDate || !order.Currency)
                    return showToast("Lütfen zorunlu alanları doldurun.");

                // 🔹 Kalemleri topla
                document.querySelectorAll("#itemsContainer .item-row").forEach((row, index) => {
                    const productId = row.querySelector(".product-select").value;
                    const quantity = parseFloat(row.querySelector(".quantity").value);
                    const price = parseFloat(row.querySelector(".price").value);
                    const unit = row.querySelector(".unit-select").value;
                    const netWeight = parseFloat(row.dataset.netKg || "0");
                    const description = row.querySelector(".description")?.value || "";
                   

                    if (productId && quantity > 0 && price > 0 && unit) {
                        order.Items.push({
                            RowNumber: index + 1,
                            ProductId: productId,
                            Quantity: quantity,
                            Price: price,
                            PackingInfo : unit,
                            NetWeight: netWeight,
                            Description: description
                        });
                      }else {
          invalidRows.push(index + 1)
                      }
                      });

                if (order.Items.length === 0)
                    return showToast("En az bir ürün satırı girilmeli.");
                        if (invalidRows.length > 0)
        return showToast(`❌ ${invalidRows.join(", ")} numaralı satırlarda eksik alan(lar) var.`);

                                   // 🔹 ÖZET MODALINI KART FORMATINDA OLUŞTURMA
        summary = "";

        order.Items.forEach(i => {
            const name = document.querySelector(
                `.product-select option[value='${i.ProductId}']`
            )?.text || "-";

            const total = (i.NetWeight || 0) * (i.Price || 0);

            summary += `
            <div class="summary-item">

                <!-- Ürün başlığı -->
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary me-2">#${i.RowNumber}</span>
                    <strong class="summary-product-name">${name}</strong>
                </div>

                <!-- Alt bilgiler -->
                <div class="summary-details">
                    <span><b>${i.Quantity}</b> ${i.PackingInfo}</span> |
                    <span><b>${i.NetWeight.toFixed(2)}</b> Kg</span> |
                    <span><b>${total.toFixed(2)}</b> ${order.Currency}</span>
                </div>

            </div>`;
        });

        // Modal içine bas
        document.getElementById("orderSummaryBody").innerHTML = summary;

        // Aç
        const modal = new bootstrap.Modal(document.getElementById("orderSummaryModal"));
        modal.show();

            // ⬇️ Bu veriyi modal onayında kullanılmak üzere geçici olarak global değişkende tut
            window._pendingOrderData = order;
        });               
                    document.getElementById("confirmSaveBtn").addEventListener("click", async () => {
        const order = window._pendingOrderData;
        if (!order) return;
            console.log("📦 Giden JSON:", order);
        const modal = bootstrap.Modal.getInstance(document.getElementById("orderSummaryModal"));
        modal.hide();
               // ======== SAYFA KİLİTLEME + LOADING OVERLAY ========
        const overlay = document.createElement("div");
        overlay.id = "savingOverlay";
        overlay.style.position = "fixed";
        overlay.style.top = "0";
        overlay.style.left = "0";
        overlay.style.width = "100vw";
        overlay.style.height = "100vh";
        overlay.style.background = "rgba(0,0,0,0.4)"; // hafif karartma
        overlay.style.backdropFilter = "blur(3px)";
        overlay.style.zIndex = "9999";
        overlay.style.display = "flex";
        overlay.style.flexDirection = "column";
        overlay.style.justifyContent = "center";
        overlay.style.alignItems = "center";
        overlay.innerHTML = `
            <div class="spinner-border text-light" style="width: 3rem; height: 3rem;"></div>
            <div style="margin-top: 15px; font-size: 1.4rem; color:white;">Please wait...</div>
        `;
        document.body.appendChild(overlay);

        // Sayfa tamamen kilitlensin
        document.body.style.pointerEvents = "none";
                       const token = sessionStorage.getItem("AccessToken");
                         /*------------KAyıt Onayı ile-------------*/
                try {
                      // const token = sessionStorage.getItem("AccessToken");
                    const res = await fetch("/api/orders/create", {
                        method: "POST",
                          headers: { "Content-Type": "application/json",
                  "Authorization": "Bearer " + token
                          },
                        body: JSON.stringify(order)
                    });
                      console.log("📦 Giden JSON:", order);

                    if (res.ok) {
                        alert("✅ Sipariş başarıyla kaydedildi!");
                          formChanged = false;
                          window.location.href = "/OrdersUIList";
                    }
                    else {
                        const errorText = await res.text();
                        showToast("❌ Kayıt başarısız: " + errorText + ". Veri silinmedi, daha sonra gönderilecektir.");
                        saveOrderOffline(order);
                          document.body.style.pointerEvents = "auto";
          overlay.remove();
                    }
                } catch (err) {
                    console.warn("🌐 Sunucuya erişilemedi. Offline kayıt başlatılıyor...");
                    showToast("⚠️ İnternet yok. Sipariş yerel olarak kaydedildi.");
                    saveOrderOffline(order);
                      document.body.style.pointerEvents = "auto";
          overlay.remove();
                }                
            });
                    function saveOrderOffline(order) {
            const key = "pendingOrders";
            let existing = JSON.parse(localStorage.getItem(key) || "[]");

            // Aynı sipariş daha önce kayıtlıysa güncelle
            const isDuplicate = existing.some(o =>
                o.Uid === order.Uid);
            

            if (isDuplicate) {
                console.warn("⚠️ Aynı sipariş zaten kayıtlı.");
                return;
            }

            existing.push(order);

            // Gereksiz veri birikmesini önle (örn: 50 kayıtla sınırlı)
            if (existing.length > 50) {
                existing = existing.slice(existing.length - 50);
            }

            localStorage.setItem(key, JSON.stringify(existing));
            console.info("💾 Sipariş offline kaydedildi.");
        }


                    async function retryPendingOrders() {
            const pending = JSON.parse(localStorage.getItem("pendingOrders") || "[]");
            if (!pending.length) return;

            const token = sessionStorage.getItem("AccessToken");
            if (!token) {
                console.warn("🔐 Token yok. Login olmadan offline kayıtlar gönderilemez.");
                return;
            }
              console.log("📦 Token bulundu, değeri:", token);
            const successful = [];

            for (const order of pending) {
                try {
                    const res = await fetch("/api/orders/create", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token
                        },
                        body: JSON.stringify(order)
                    });

                    if (res.ok) {
                        successful.push(order);
                    } else {
                        const errText = await res.text();
                        console.warn(`🛑 Sipariş gönderilemedi: ${res.status} - ${errText}`);
                           console.error("❌ Sunucudan hata geldi:", res.status, errText);
                    }
                } catch (err) {
                    console.error("🚨 Ağ hatası:", err);
                }
            }

            // Temizleme
            if (successful.length > 0) {
                const remaining = pending.filter(o => !successful.some(s => s.Uid === o.Uid));
                localStorage.setItem("pendingOrders", JSON.stringify(remaining));
                showToast(`📦 ${successful.length} bekleyen sipariş başarıyla gönderildi.`);
            }
        }

        window.addEventListener("load", retryPendingOrders);

        document.getElementById("addItem").addEventListener("click", addOrderItemRow);

        document.addEventListener("click", function(e) {
            const dd = document.getElementById("smartProductDropdown");

            // Panel açıksa ve dışarı tıklanmışsa → desktop’da kapanır
            if (!dd.classList.contains("hidden")
                && window.innerWidth > 768
                && !dd.contains(e.target)
                && !e.target.classList.contains("product-select"))
            {
                dd.classList.add("hidden");
            }
        });
    

    </script>
}

