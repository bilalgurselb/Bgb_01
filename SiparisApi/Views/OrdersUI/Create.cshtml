@{
    ViewData["Title"] = "Yeni Sipariş Oluştur";
    Layout = "_Layout";
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<div class="form-card bg-white shadow-sm p-3 rounded">
    <form id="createOrderForm">

        <!-- 🔹 MÜŞTERİ SEÇİMİ -->
        <div class="form-group mb-3">
            <label>Müşteri</label>
            <select id="customerSelect" class="form-control" required></select>
            <div id="customerInfo" class="text-muted small mt-1"></div>
        </div>

        <!-- 🔹 SATIŞ TEMSİLCİSİ -->
        <div class="form-group mb-3">
            <label>Representative</label>
            <select id="salesRepSelect" class="form-control" required></select>
        </div>

        <!-- 🔹 TARİHLER -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Order Date</label>
                <input type="date" id="orderDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" required />
            </div>
            <div class="col-md-6 mb-3">
                <label>Delivery Date</label>
                <input type="date" id="deliveryDate" class="form-control" />
            </div>
        </div>

        <!-- 🔹 ÖDEME & TAŞIMA ŞARTLARI -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Payment Term</label>
                <select id="paymentTerm" class="form-control" required></select>
            </div>
            <div class="col-md-6 mb-3">
                <label>Transport Type</label>
                <select id="transport" class="form-control" required></select>
            </div>
        </div>

        <!-- 🔹 TESLİMAT BİLGİLERİ -->
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>Port of Delivery</label>
                <select id="portOfDelivery" class="form-control" ></select>
            </div>
            <div class="col-md-6 mb-3">
                <label>Place of Delivery</label>
                <select id="placeOfDelivery" class="form-control" ></select>
            </div>
            <div class="form-group mb-3">
                <label>Delivery Term</label>
                <select id="deliveryTerm" class="form-select" >
                    <option value="">Choose...</option>
                    <option value="CFR">CFR (Cost and Freight)</option>
                    <option value="CIF">CIF (Cost, Insurance and Freight)</option>
                    <option value="FOB">FOB (Free on Board)</option>
                    <option value="DAP">DAP (Delivered At Place)</option>
                </select>
            </div>
            <div class="form-group mb-3">
                <label for="dueDays">Due Date (Days)</label>
                <input type="number" id="dueDays" class="form-control" inputmode="numeric" min="0" step="1" placeholder="örnek: 30" />
            </div>
        </div>

        <!-- 🔹 PARA BİRİMİ -->
        <div class="form-group mb-3">
            <label>Currency</label>
            <select id="currency" class="form-control" required></select>
        </div>

        <!-- 🔹 ÜRÜN SATIRLARI -->
        <div class="mt-4">
            <h5><i class="fas fa-box text-success"></i>Products</h5>
            <div id="itemsContainer"></div>
            <button type="button" id="addItem" class="btn btn-sm btn-success mt-2">
                <i class="fas fa-plus"></i> Add Product
            </button>
        </div>

        <!-- 🔹 KAYDET -->
        <button type="submit" class="btn btn-primary w-100 mt-4">
            <i class="fas fa-save"></i> Kaydet
        </button>
    </form>
</div>

<!-- 🔹 TOAST & MODAL -->
<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1080">
    <div id="toastWarning" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">⚠️ Eksik veya hatalı bilgi var. Lütfen kontrol edin.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<div class="modal fade" id="orderSummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Sipariş Özeti</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderSummaryBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-success" id="confirmSaveBtn">Kaydet</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="/js/lookups.js"></script>
    <script>
              
        /* === 🧩 SİNTAN: Sayfa Yenilemeyi Engelleme (Desktop + Mobile) === */
        document.addEventListener("DOMContentLoaded", () => {

            // 🔹 Masaüstü için klasik yenilemeyi engelle
            window.addEventListener("beforeunload", e => {
                const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
                if (!isMobile) {
                    e.preventDefault();
                    e.returnValue = ""; // Chrome, Edge, Firefox için
                }
            });

              loadLookups();
              addOrderItemRow();
            // 🔹 Mobilde "çek-bırak yenileme"yi engelle (Android & iOS)
            let touchStartY = 0;
            document.addEventListener("touchstart", e => {
                touchStartY = e.touches[0].clientY;
            });

            document.addEventListener("touchmove", e => {
                const touchCurrentY = e.touches[0].clientY;
                const scrollTop = document.scrollingElement.scrollTop;
                // Sayfanın en üstünde aşağı çekiliyorsa: (pull-to-refresh)
                if (scrollTop === 0 && touchCurrentY > touchStartY) {
                    e.preventDefault();
                }
            }, { passive: false });

            // 🔹 Formdaki değişiklikleri algıla (ekstra güvenlik)
            let formChanged = false;
            document.querySelectorAll("#createOrderForm input, #createOrderForm select")
              .forEach(el => el.addEventListener("input", () => formChanged = true));

            // Geri tuşu veya yönlendirme engellemesi (SPA senaryosu)
            window.addEventListener("popstate", e => {
                if (formChanged && !confirm("Kaydedilmemiş değişiklikler var. Devam etmek istiyor musunuz?")) {
                    history.pushState(null, null, location.href);
                    e.preventDefault();
                }
            });
        });
    
        // 🔹 ÜRÜN SATIRI EKLE
        function addOrderItemRow() {
            const container = document.getElementById("itemsContainer");
            const rowIndex = container.children.length + 1;

            const row = document.createElement("div");
            row.classList.add("item-row", "border", "p-2", "rounded", "mb-2", "bg-white", "shadow-sm");

                    row.innerHTML = `
          <div class="item-row-header d-flex justify-content-between align-items-center mb-2">
            <span class="badge bg-primary">#${rowIndex}</span>
            <button type="button" class="btn btn-outline-danger btn-sm remove-item" aria-label="Remove">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- 🔹 Ürün bilgileri -->
          <div class="col-12 mb-2">
            <label>Product</label>
            <select class="product-select" required></select>
          </div>

          <div class="row">
            <div class="col-6 mb-2">
              <label>Quantity</label>
              <input type="number" class="form-control quantity" inputmode="decimal" step="0.01" placeholder="Enter quantity" required>
            </div>

            <div class="col-6 mb-2">
              <label>Unit</label>
              <select class="form-control unit-select" required></select>
            </div>
        <div class="col-md-5 mb-2">
          <label>Price</label>
          <div class="input-group">
            <span class="input-group-text price-symbol">€</span>
            <input type="number"
                   class="form-control price"
                   inputmode="decimal"
                   step="0.0001"
                   required
                   placeholder="Enter price" />
          </div>
        </div>

             <div class="col-md-5 mb-2">
          <label>Total</label>
          <div class="input-group">
            <input type="text"
                   class="form-control total-amount"
                   value="0.00"
                   readonly />
            <span class="input-group-text currency-label">€</span>
          </div>
        </div>

        `;
            container.appendChild(row);
                    const select = row.querySelector(".product-select");
        select.id = `productselect_${Date.now()}`; // Backtick kullanımı
        loadProducts(select);   
        
            loadUnits(row.querySelector(".unit-select"));
            updateRowNumbers();
            document.getElementById("currency")?.dispatchEvent(new Event("change"));
        }
        // 🔹 Satır numaralarını yeniden sırala
        function updateRowNumbers() {
            document.querySelectorAll("#itemsContainer .item-row").forEach((row, index) => {
                const badge = row.querySelector(".badge");
                if (badge) badge.textContent = `#${index + 1}`;
            });
        }
        // 🔹 Ürün Satırı Silme (Delegated Listener)
        document.addEventListener("click", function (e) {
            const btn = e.target.closest(".remove-item");
            if (!btn) return;

            const row = btn.closest(".item-row");
            if (row) {
                row.remove();
                updateRowNumbers();
            }
        });

        // 🔹 TOAST
        function showToast(msg) {
            const toastEl = document.getElementById("toastWarning");
            toastEl.querySelector(".toast-body").innerText = msg;
            new bootstrap.Toast(toastEl).show();
        }

        document.getElementById("createOrderForm").addEventListener("submit", function (e) {
            e.preventDefault(); // Formun klasik gönderimini iptal eder
        });
        /*---HESAPLAMA-------*/addOrderItemRow
                /* === 🔹 HESAP MODÜLÜ (Bankacılık Tipi Para Hesabı) === */


        /* --- 🔹 Ondalık normalizasyonu --- */
        function normalizeFloat(v) {
            if (typeof v === "string") v = v.replace(",", ".").trim();
            return parseFloat(v) || 0;
        }

        /* --- 🔹 Banker’s rounding (Round half even) --- */
        function roundBankers(value, decimals = 2) {
            const factor = Math.pow(10, decimals);
            const n = value * factor;
            const f = Math.floor(n);
            const diff = n - f;

            if (diff > 0.5) return (f + 1) / factor;
            if (diff < 0.5) return f / factor;
            // Tam ortadaysa çift sayıya yuvarla
            return (f % 2 === 0 ? f : f + 1) / factor;
        }

        /* --- 🔹 Bankacılık tipi çarpım --- */
        function preciseMoneyMultiply(price, qty) {
            const p = Math.round(normalizeFloat(price) * 10000); // 4 ondalık precision
            const q = Math.round(normalizeFloat(qty) * 10000);
            const result = (p * q) / 100000000; // 8 ondalık
            return roundBankers(result, 2);
        }



        function recalcRowTotal(row) {
            if (!row) return;

            const qtyEl   = row.querySelector(".quantity");
            const priceEl = row.querySelector(".price");
            const totalEl = row.querySelector(".total-amount");
            const unitEl  = row.querySelector(".unit-select");
            const curEl   = row.querySelector(".currency-label");
            const lblInfo = row.querySelector(".net-weight-info");

            const cur = document.getElementById("currency")?.value || "EURO";
            const symbols = { USD: "$", EURO: "€", TL: "₺", RUBLE: "₽" };
            const sym = symbols[cur] || "";

            const qty = parseFloat(qtyEl.value) || 0;
            const price = parseFloat(priceEl.value) || 0;
            const unit = unitEl?.value || "";


        const packWeight = normalizeFloat(row.dataset.packWeight);
        const palletNet  = normalizeFloat(row.dataset.palletNet);

        let netKg = 0;

             if (!unit) {
            if (lblInfo) lblInfo.textContent = `Net Weight: ${row.dataset.netKg || '-'}`;
            if (totalEl) totalEl.value = "0.00";
            return;
        }

        switch (unit) {
            case "Pallets":
                netKg = qty * palletNet;
                break;
            case "Pieces":
            case "IBC":
                netKg = qty * packWeight;
                break;
        }
           if (lblInfo) {
          lblInfo.textContent = `Net Weight: ${netKg.toFixed(2)} KG`;
          row.dataset.netKg = netKg.toFixed(2);
           }
           

            const total = preciseMoneyMultiply(price, netKg);

            if (totalEl) totalEl.value = total.toFixed(2);
            if (curEl) curEl.textContent = sym;



            if (lblInfo)
                lblInfo.textContent = netKg > 0 ? `Net Weight: ${netKg.toFixed(2)} kg` : "Net Weight: -";

            row.style.borderLeft = total > 0 ? "4px solid #47AAC6" : "4px solid transparent";
        }
           /* --- 🔹 Toplamlar (Alt Toplam, KDV, Genel Toplam) --- */
          function calculateOrderTotals() {
              let subtotal = 0;
              document.querySelectorAll('.total-amount').forEach(el => {
                  subtotal += normalizeFloat(el.value);
              });

           /*   const vatRate = 0.18;
              const vat = roundBankers(subtotal * vatRate, 2);
              const grandTotal = roundBankers(subtotal + vat, 2);

              document.getElementById('subtotalDisplay')?.textContent = subtotal.toFixed(2);
              document.getElementById('vatDisplay')?.textContent = vat.toFixed(2);
              document.getElementById('grandTotalDisplay')?.textContent = grandTotal.toFixed(2);*/
          }

            
        
                /* --- 🔹 Tetikleyiciler (Event Binding) --- */

        // Miktar, fiyat veya birim değişince
        document.addEventListener('change', e => {
            if (e.target.matches('.quantity, .price, .unit-select')) {
                const row = e.target.closest('.item-row');
                if (row) {
                    recalcRowTotal(row);
                    calculateOrderTotals();
                }
            }
        });

        // Para birimi değişince
        document.getElementById('currency')?.addEventListener('change', () => {
            document.querySelectorAll('.item-row').forEach(row => recalcRowTotal(row));
            calculateOrderTotals();
        });



        // === Currency seçilince Price yanına sembol yaz ===
      (function attachCurrencySymbolBinding(){
            const cur = document.getElementById("currency");
            if (!cur) return;
            const symbols = { USD: "$", EURO: "€", TL: "₺", RUBLE: "₽" };

            function refreshSymbols(){
                const symbol = symbols[cur.value] || "";
                  document.querySelectorAll(".price-symbol").forEach(el => el.textContent = symbol);
             document.querySelectorAll(".currency-label").forEach(el => el.textContent = symbol);
              }
            cur.addEventListener("change", refreshSymbols);
            setTimeout(refreshSymbols, 0);
        })();





        // 🔹 KAYDET
        document.getElementById("createOrderForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const order = {
                CustomerId: document.getElementById("customerSelect").value,
                SalesRepId: document.getElementById("salesRepSelect").value,
                OrderDate: document.getElementById("orderDate").value,
                DeliveryDate: document.getElementById("deliveryDate").value,
                PaymentTerm: document.getElementById("paymentTerm").value,
                Transport: document.getElementById("transport").value,
                PortOfDelivery: document.getElementById("portOfDelivery").value,
                PlaceOfDelivery: document.getElementById("placeOfDelivery").value,
                DeliveryTerm: document.getElementById("deliveryTerm").value,
                DueDays: parseInt(document.getElementById("dueDays").value) || 0,
                Currency: document.getElementById("currency").value,
                Items: []
            };

            if (!order.CustomerId) return showToast("Lütfen müşteri seçin.");

            document.querySelectorAll("#itemsContainer .item-row").forEach((row, index) => {
                const productId = row.querySelector(".product-select").value;
                const quantity = parseFloat(row.querySelector(".quantity").value);
                const price = parseFloat(row.querySelector(".price").value);
                if (productId && quantity > 0 && price > 0) {
                    order.Items.push({ RowNumber: index + 1, ProductId: productId, Quantity: quantity, Price: price });
                  }recalcRowTotal(row);
            });

            if (order.Items.length === 0) return showToast("En az bir ürün satırı eklemelisiniz.");

            // Sipariş özeti modal

            let summary = `<table class="table table-sm"><thead><tr><th>#</th><th>Ürün</th><th>Miktar</th><th>Fiyat</th></tr></thead><tbody>`;
            order.Items.forEach(i => {
                const name = document.querySelector(`.product-select option[value='${i.ProductId}']`)?.text || "-";
                summary += `<tr><td>${i.RowNumber}</td><td>${name}</td><td>${i.Quantity}</td><td>${i.Price}</td></tr>`;
            });
            summary += `</tbody></table>`;
            document.getElementById("orderSummaryBody").innerHTML = summary;
            const modal = new bootstrap.Modal(document.getElementById("orderSummaryModal"));
            modal.show();

            document.getElementById("confirmSaveBtn").onclick = async () => {
                modal.hide();
                const res = await fetch("/api/orders/create", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(order)
                });
                if (res.ok) {
                    alert("✅ Sipariş başarıyla kaydedildi!");
                    window.location.href = "/OrdersUIList/Index";
                } else showToast("Kayıt başarısız.");
            };
        });

        window.addEventListener("pageshow", e => {
            if (e.persisted) console.log("Sayfa cache'den yüklendi.");
        });
        document.getElementById("addItem").addEventListener("click", addOrderItemRow);
    </script>
}

